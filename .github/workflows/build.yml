name: Build Chopin Kernel - 1
on:
  push:
    branches:
      - lineage-20

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up Java
      uses: actions/setup-java@v2
      with:
        java-version: '11'

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install git ccache automake flex lzop bison \
        gperf build-essential zip curl zlib1g-dev zlib1g-dev:i386 \
        g++-multilib python-networkx libxml2-utils bzip2 libbz2-dev \
        libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush \
        schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev \
        pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl \
        libxml-simple-perl bc libc6-dev-i386 lib32ncurses5-dev \
        x11proto-core-dev libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip

    - name: Clone Kernel Repository
      run: |
        git clone --depth=1 https://github.com/Chopin-Ella-Dev/kernel_xiaomi_chopin -b lineage-20
        cd kernel_xiaomi_chopin
        git clone https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 toolchain
        mkdir out
        export ARCH=arm64
        export SUBARCH=arm64
        export DTC_EXT=dtc
        export CROSS_COMPILE=${PWD}/toolchain/bin/aarch64-linux-android-
        make O=out nitrogen_user_defconfig

    - name: Build Kernel
      run: |
        cd kernel_xiaomi_chopin
        make -j$(nproc) O=out 2>&1 | tee kernel.log

    - name: Upload Kernel Artifact
      uses: actions/upload-artifact@v2
      with:
        name: kernel-artifact
        path: kernel_xiaomi_chopin/out/
